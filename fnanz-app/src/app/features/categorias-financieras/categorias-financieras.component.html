<section class="card categoria-panel shadow-sm border-0">
  <div class="card-body">
    <div class="categoria-panel__header">
      <div>
        <h2 class="card-title mb-1">Categorias</h2>
        <p class="card-subtitle text-muted">
          Administra las categorias utilizadas para clasificar ingresos y egresos.
        </p>
      </div>
      <button type="button" class="btn btn-primary" (click)="startCreate()" [disabled]="loading() || saving()">
        Nueva categoria
      </button>
    </div>

    <div *ngIf="loading()" class="alert alert-info mt-3 mb-0" role="status">Cargando información...</div>
    <div *ngIf="error() && !loading()" class="alert alert-danger mt-3 mb-0" role="alert">{{ error() }}</div>

    <section *ngIf="showForm()" class="categoria-form-wrapper mt-4">
      <div class="card border-dark categoria-form-card">
        <div class="card-header">
          <h5 class="mb-0">{{ formTitle() }}</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="form" (ngSubmit)="submitForm()" novalidate>
            <div class="mb-3">
              <label for="categoriaNombre" class="form-label fw-semibold">Nombre</label>
              <input
                id="categoriaNombre"
                type="text"
                formControlName="nombre"
                class="form-control"
                [class.is-invalid]="hasControlError('nombre')"
              />
              <div class="invalid-feedback" *ngIf="form.controls.nombre.touched && form.controls.nombre.hasError('required')">
                El nombre es obligatorio.
              </div>
              <div class="invalid-feedback" *ngIf="form.controls.nombre.touched && form.controls.nombre.hasError('maxlength')">
                El nombre debe tener menos de 120 caracteres.
              </div>
              <div class="invalid-feedback" *ngIf="getServerError('nombre') as serverError">{{ serverError }}</div>
            </div>

            <div class="mb-3">
              <label for="categoriaTipo" class="form-label fw-semibold">Tipo</label>
              <select
                id="categoriaTipo"
                formControlName="tipo"
                class="form-select"
                [class.is-invalid]="hasControlError('tipo')"
              >
                <option *ngFor="let tipo of tipoOptions" [value]="tipo">{{ tipo }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="getServerError('tipo') as serverError">{{ serverError }}</div>
            </div>

            <div class="mb-3">
              <label class="form-label d-block" for="categoriaActiva">Estado</label>
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  role="switch"
                  id="categoriaActiva"
                  formControlName="activo"
                />
                <label class="form-check-label" for="categoriaActiva">Activo</label>
              </div>
              <div class="form-text">{{ form.controls.activo.value ? 'La categoria estará activa' : 'La categoria estará inactiva' }}</div>
              <div class="invalid-feedback d-block" *ngIf="getServerError('activo') as serverError">{{ serverError }}</div>
            </div>

            <div class="mb-3">
              <label for="categoriaOrden" class="form-label">Orden</label>
              <input
                id="categoriaOrden"
                type="number"
                formControlName="orden"
                class="form-control"
                [class.is-invalid]="hasControlError('orden')"
              />
              <div class="invalid-feedback" *ngIf="getServerError('orden') as serverError">{{ serverError }}</div>
            </div>

            <div class="mb-4">
              <label for="categoriaDescripcion" class="form-label">Descripción</label>
              <textarea
                id="categoriaDescripcion"
                rows="3"
                formControlName="descripcion"
                class="form-control"
                [class.is-invalid]="hasControlError('descripcion')"
              ></textarea>
              <div class="invalid-feedback" *ngIf="getServerError('descripcion') as serverError">{{ serverError }}</div>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <button type="button" class="btn btn-outline-secondary" (click)="cancelForm()">Cancelar</button>
              <button type="submit" class="btn btn-primary" [disabled]="saving()">
                {{ saving() ? 'Guardando...' : 'Guardar' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <ng-container *ngIf="!showForm()">
      <div class="categoria-grid" *ngIf="!loading() && categorias().length > 0; else emptyState">
        <div class="card border-0 shadow-sm mt-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Nombre</th>
                    <th scope="col">Tipo</th>
                    <th scope="col">Estado</th>
                    <th scope="col">Orden</th>
                    <th scope="col">Descripción</th>
                    <th scope="col" class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let categoria of categorias(); trackBy: trackByCategoriaId">
                    <td class="fw-semibold">{{ categoria.nombre }}</td>
                    <td>
                      <span class="tipo-pill" [ngClass]="categoria.tipo === 'INGRESO' ? 'tipo-pill--ingreso' : 'tipo-pill--egreso'">
                        {{ categoria.tipo }}
                      </span>
                    </td>
                    <td>
                      <span [ngClass]="categoria.activo ? 'estado estado--activo' : 'estado estado--inactivo'">
                        {{ categoria.activo ? 'Activo' : 'Inactivo' }}
                      </span>
                    </td>
                    <td>{{ categoria.orden ?? '—' }}</td>
                    <td>{{ categoria.descripcion || 'Sin descripción' }}</td>
                    <td class="text-end">
                      <button
                        type="button"
                        class="btn btn-outline-primary action-icon-button me-1"
                        (click)="startEdit(categoria)"
                        [disabled]="loading() || saving()"
                        [attr.aria-label]="'Editar categoria: ' + categoria.nombre"
                        [attr.title]="'Editar categoria'"
                      >
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <path d="M12 20h9" />
                          <path
                            d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"
                          />
                        </svg>
                        <span class="visually-hidden">Editar</span>
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-danger action-icon-button"
                        (click)="promptDelete(categoria)"
                        [disabled]="loading() || saving()"
                        [attr.aria-label]="'Eliminar categoria: ' + categoria.nombre"
                        [attr.title]="'Eliminar categoria'"
                      >
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <polyline points="3 6 5 6 21 6" />
                          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                          <path d="M10 11v6" />
                          <path d="M14 11v6" />
                          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                        </svg>
                        <span class="visually-hidden">Eliminar</span>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <ng-template #emptyState>
        <div class="alert alert-secondary mt-4" *ngIf="!loading()">
          No hay categorias registradas aún. Crea la primera para comenzar.
        </div>
      </ng-template>
    </ng-container>

    <ng-container *ngIf="categoriaPendingDelete() as categoria">
      <div
        class="modal fade show d-block categoria-delete-modal"
        tabindex="-1"
        role="dialog"
        aria-modal="true"
        aria-labelledby="categoriaDeleteModalLabel"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="categoriaDeleteModalLabel">Eliminar categoria</h5>
              <button
                type="button"
                class="btn-close"
                aria-label="Cerrar"
                (click)="closeDeleteDialog()"
                [disabled]="deleting()"
              >
                <span aria-hidden="true"></span>
              </button>
            </div>
            <div class="modal-body">
              <p>¿Desea eliminar la categoria "{{ categoria.nombre }}"?</p>
              <p class="mb-0 text-muted">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-danger"
                (click)="confirmDeleteCategoria()"
                [disabled]="deleting()"
              >
                {{ deleting() ? 'Eliminando...' : 'Eliminar' }}
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="closeDeleteDialog()"
                [disabled]="deleting()"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-backdrop fade show" style="display: block;"></div>
    </ng-container>
  </div>
</section>
