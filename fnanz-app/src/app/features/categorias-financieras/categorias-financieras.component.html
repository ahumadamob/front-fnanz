<section class="card categoria-panel">
  <header class="categoria-panel__header">
    <div>
      <h2>Categorias</h2>
      <p class="categoria-panel__subtitle">
        Administra las categorias utilizadas para clasificar ingresos y egresos.
      </p>
    </div>
    <button type="button" class="primary-button" (click)="startCreate()" [disabled]="loading() || saving()">
      Nueva categoria
    </button>
  </header>

  <p *ngIf="loading()" class="categoria-panel__loading">Cargando información...</p>
  <p *ngIf="error() && !loading()" class="categoria-panel__error">{{ error() }}</p>

  <section *ngIf="showForm()" class="categoria-form card border-0 shadow-sm">
    <div class="card-body">
      <form [formGroup]="form" (ngSubmit)="submitForm()" novalidate>
        <fieldset class="categoria-form__fieldset">
          <legend class="categoria-form__legend">{{ formTitle() }}</legend>

          <div class="row g-4">
            <div class="col-12 col-md-6 col-lg-3">
              <label for="categoriaNombre" class="form-label fw-semibold">Nombre</label>
              <input
                id="categoriaNombre"
                type="text"
                formControlName="nombre"
                class="form-control"
                [class.is-invalid]="hasControlError('nombre')"
              />
              <div class="invalid-feedback" *ngIf="form.controls.nombre.touched && form.controls.nombre.hasError('required')">
                El nombre es obligatorio.
              </div>
              <div class="invalid-feedback" *ngIf="form.controls.nombre.touched && form.controls.nombre.hasError('maxlength')">
                El nombre debe tener menos de 120 caracteres.
              </div>
              <div class="invalid-feedback" *ngIf="getServerError('nombre') as serverError">{{ serverError }}</div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
              <label for="categoriaTipo" class="form-label fw-semibold">Tipo</label>
              <select
                id="categoriaTipo"
                formControlName="tipo"
                class="form-select"
                [class.is-invalid]="hasControlError('tipo')"
              >
                <option *ngFor="let tipo of tipoOptions" [value]="tipo">{{ tipo }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="getServerError('tipo') as serverError">{{ serverError }}</div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label d-block" for="categoriaActiva">Estado</label>
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  role="switch"
                  id="categoriaActiva"
                  formControlName="activo"
                />
                <label class="form-check-label" for="categoriaActiva">Activo</label>
              </div>
              <div class="form-text">{{ form.controls.activo.value ? 'La categoria estará activa' : 'La categoria estará inactiva' }}</div>
              <div class="invalid-feedback d-block" *ngIf="getServerError('activo') as serverError">{{ serverError }}</div>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
              <label for="categoriaOrden" class="form-label">Orden</label>
              <input
                id="categoriaOrden"
                type="number"
                formControlName="orden"
                class="form-control"
                [class.is-invalid]="hasControlError('orden')"
              />
              <div class="invalid-feedback" *ngIf="getServerError('orden') as serverError">{{ serverError }}</div>
            </div>

            <div class="col-12">
              <label for="categoriaDescripcion" class="form-label">Descripción</label>
              <textarea
                id="categoriaDescripcion"
                rows="3"
                formControlName="descripcion"
                class="form-control"
                [class.is-invalid]="hasControlError('descripcion')"
              ></textarea>
              <div class="invalid-feedback" *ngIf="getServerError('descripcion') as serverError">{{ serverError }}</div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-outline-secondary" (click)="cancelForm()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="saving()">
              {{ saving() ? 'Guardando...' : 'Guardar' }}
            </button>
          </div>
        </fieldset>
      </form>
    </div>
  </section>

  <div class="categoria-grid" *ngIf="!loading() && categorias().length > 0; else emptyState">
    <table class="data-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Orden</th>
          <th>Descripción</th>
          <th class="data-table__actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let categoria of categorias(); trackBy: trackByCategoriaId">
          <td>
            <div class="categoria-name">{{ categoria.nombre }}</div>
            <small class="categoria-meta">Creada {{ categoria.creadoEn | date: 'short' }}</small>
          </td>
          <td>
            <span class="tipo-pill" [ngClass]="categoria.tipo === 'INGRESO' ? 'tipo-pill--ingreso' : 'tipo-pill--egreso'">
              {{ categoria.tipo }}
            </span>
          </td>
          <td>
            <span [ngClass]="categoria.activo ? 'estado estado--activo' : 'estado estado--inactivo'">
              {{ categoria.activo ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td>{{ categoria.orden ?? '—' }}</td>
          <td>{{ categoria.descripcion || 'Sin descripción' }}</td>
          <td class="data-table__actions">
            <button
              type="button"
              class="ghost-button icon-button"
              (click)="startEdit(categoria)"
              [disabled]="loading() || saving()"
              [attr.aria-label]="'Editar categoria: ' + categoria.nombre"
              [attr.title]="'Editar categoria'"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M12 20h9" />
                <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
              </svg>
            </button>
            <button
              type="button"
              class="danger-button icon-button"
              (click)="promptDelete(categoria)"
              [disabled]="loading() || saving()"
              [attr.aria-label]="'Eliminar categoria: ' + categoria.nombre"
              [attr.title]="'Eliminar categoria'"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                <path d="M10 11v6" />
                <path d="M14 11v6" />
                <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
              </svg>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #emptyState>
    <p class="categoria-panel__empty" *ngIf="!loading()">
      No hay categorias registradas aún. Crea la primera para comenzar.
    </p>
  </ng-template>

  <app-confirm-dialog
    [open]="categoriaPendingDelete() !== null"
    title="Eliminar categoria"
    [message]="deleteMessage()"
    confirmLabel="Eliminar"
    cancelLabel="Cancelar"
    busyLabel="Eliminando..."
    [busy]="deleting()"
    [confirmDestructive]="true"
    (cancel)="closeDeleteDialog()"
    (confirm)="confirmDeleteCategoria()"
  ></app-confirm-dialog>
</section>
