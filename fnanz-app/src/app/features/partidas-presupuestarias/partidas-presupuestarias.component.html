<section class="budgets">
  <header class="budgets__hero">
    <div class="budgets__hero-text">
      <p class="budgets__eyebrow">Asignaciones</p>
      <h2 class="budgets__title">Presupuestos</h2>
      <p class="budgets__description">
        Administra las partidas presupuestarias asignadas a los periodos financieros de tu organización.
      </p>
    </div>
    <button
      type="button"
      class="primary-button budgets__hero-action"
      (click)="startCreate()"
      [disabled]="loading() || saving() || selectedPeriodoId() === null"
    >
      Nueva partida presupuestaria
    </button>
  </header>

  <div class="card budgets__panel">
    <p *ngIf="loading()" class="budgets__banner budgets__banner--info">Cargando información...</p>
    <p *ngIf="error() && !loading()" class="budgets__banner budgets__banner--error">{{ error() }}</p>
    <p *ngIf="categoriasError()" class="budgets__banner budgets__banner--warning">{{ categoriasError() }}</p>
    <p *ngIf="periodosError()" class="budgets__banner budgets__banner--warning">{{ periodosError() }}</p>
    <p *ngIf="periodosDropdownError()" class="budgets__banner budgets__banner--warning">{{ periodosDropdownError() }}</p>

    <section *ngIf="!showForm() && !viewingPartida()" class="budgets__filters">
      <label class="filter-field">
        <span>Periodo</span>
        <select
          [disabled]="periodosDropdownLoading() || periodosDropdown().length === 0"
          [value]="selectedPeriodoId() ?? ''"
          (change)="onPeriodoDropdownChange($any($event.target).value)"
        >
          <option value="">Selecciona un periodo</option>
          <option *ngFor="let periodo of periodosDropdown()" [value]="periodo.id">
            {{ periodo.nombre }}
          </option>
        </select>
      </label>

      <label class="filter-checkbox">
        <input
          type="checkbox"
          [checked]="includePeriodosCerrados()"
          (change)="onIncludePeriodosCerradosChange($any($event.target).checked)"
        />
        <span>Incluir periodos cerrados</span>
      </label>
    </section>

    <p
      *ngIf="periodosDropdownLoading() && !showForm() && !viewingPartida()"
      class="budgets__banner budgets__banner--info budgets__banner--inline"
    >
      Cargando periodos...
    </p>

    <section *ngIf="showForm()" class="budgets-form">
      <header class="budgets-form__header">
        <h3 class="budgets-form__title">{{ formTitle() }}</h3>
        <p class="budgets-form__subtitle">Completa los detalles para registrar la partida presupuestaria.</p>
      </header>

      <form [formGroup]="form" (ngSubmit)="submitForm()" class="budgets-form__grid">
        <label class="form-field" [class.form-field--invalid]="hasControlError('tipo')">
          <span>Tipo *</span>
          <select formControlName="tipo">
            <option *ngFor="let tipo of tipoOptions" [value]="tipo">{{ tipo }}</option>
          </select>
          <small *ngIf="getServerError('tipo') as serverError">{{ serverError }}</small>
        </label>

        <label class="form-field" [class.form-field--invalid]="hasControlError('categoriaId')">
          <span>Categoría *</span>
          <select formControlName="categoriaId" [disabled]="categoriasLoading() || categorias().length === 0">
            <option [ngValue]="null" disabled>Seleccione una categoría</option>
            <option *ngFor="let categoria of categorias()" [ngValue]="categoria.id">
              {{ categoria.nombre }} ({{ categoria.tipo }})
            </option>
          </select>
          <small *ngIf="form.controls.categoriaId.touched && form.controls.categoriaId.hasError('required')">
            La categoría es obligatoria.
          </small>
          <small *ngIf="getServerError('categoriaId') as serverError">{{ serverError }}</small>
          <small *ngIf="!categoriasLoading() && categorias().length === 0">
            Debes crear al menos una categoría para asignarla a la partida presupuestaria.
          </small>
        </label>

        <label class="form-field" [class.form-field--invalid]="hasControlError('concepto')">
          <span>Concepto *</span>
          <input type="text" formControlName="concepto" [class.invalid]="form.controls.concepto.touched && form.controls.concepto.invalid" />
          <small *ngIf="form.controls.concepto.touched && form.controls.concepto.hasError('required')">
            El concepto es obligatorio.
          </small>
          <small *ngIf="form.controls.concepto.touched && form.controls.concepto.hasError('maxlength')">
            El concepto debe tener menos de 120 caracteres.
          </small>
          <small *ngIf="getServerError('concepto') as serverError">{{ serverError }}</small>
        </label>

        <label class="form-field" [class.form-field--invalid]="hasControlError('montoReservado')">
          <span>Monto reservado *</span>
          <input
            type="number"
            formControlName="montoReservado"
            step="0.01"
            min="0"
            [class.invalid]="form.controls.montoReservado.touched && form.controls.montoReservado.invalid"
          />
          <small *ngIf="form.controls.montoReservado.touched && form.controls.montoReservado.hasError('required')">
            El monto reservado es obligatorio.
          </small>
          <small *ngIf="form.controls.montoReservado.touched && form.controls.montoReservado.hasError('min')">
            El monto reservado no puede ser negativo.
          </small>
          <small *ngIf="getServerError('montoReservado') as serverError">{{ serverError }}</small>
        </label>

        <label class="form-field form-field--full" [class.form-field--invalid]="hasControlError('nota')">
          <span>Nota</span>
          <textarea rows="3" formControlName="nota"></textarea>
          <small *ngIf="form.controls.nota.touched && form.controls.nota.hasError('maxlength')">
            La nota debe tener menos de 500 caracteres.
          </small>
          <small *ngIf="getServerError('nota') as serverError">{{ serverError }}</small>
        </label>

        <div class="form-actions">
          <button type="button" class="ghost-button" (click)="promptCancelForm()" [disabled]="saving()">
            Cancelar
          </button>
          <button type="submit" class="primary-button" [disabled]="saving()">
            {{ saving() ? 'Guardando...' : 'Guardar' }}
          </button>
        </div>
      </form>
    </section>

    <div *ngIf="!showForm() && !viewingPartida()" class="budgets__table">
      <table class="data-table">
        <thead>
          <tr>
            <th>Concepto</th>
            <th>Tipo</th>
            <th>Categoría</th>
            <th>Estado</th>
            <th>Monto reservado</th>
            <th>Monto aplicado</th>
            <th class="data-table__actions">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="partidas().length === 0">
            <td class="data-table__empty" colspan="7">
              <ng-container *ngIf="loading(); else emptyMessage">
                Cargando información...
              </ng-container>
              <ng-template #emptyMessage>
                {{
                  selectedPeriodoId() === null
                    ? 'Selecciona un periodo para ver las partidas presupuestarias.'
                    : 'No hay partidas presupuestarias registradas para el periodo seleccionado.'
                }}
              </ng-template>
            </td>
          </tr>
          <tr *ngFor="let partida of partidas(); trackBy: trackByPartidaId">
            <td>
              <div class="budgets__name">{{ partida.concepto }}</div>
            </td>
            <td>
              <span class="tipo-pill" [ngClass]="partida.tipo === 'INGRESO' ? 'tipo-pill--ingreso' : 'tipo-pill--egreso'">
                {{ partida.tipo }}
              </span>
            </td>
            <td>{{ partida.categoriaNombre }}</td>
            <td>
              <span [ngClass]="'estado estado--' + partida.estado.toLowerCase()">{{ partida.estado }}</span>
            </td>
            <td class="data-table__numeric">{{ formatAccounting(partida.montoReservado) }}</td>
            <td class="data-table__numeric">{{ formatAccounting(partida.montoAplicado) }}</td>
            <td class="data-table__actions">
              <button
                type="button"
                class="ghost-button icon-button"
                (click)="viewPartida(partida)"
                [disabled]="loading() || saving()"
                [attr.aria-label]="'Ver partida presupuestaria: ' + partida.concepto"
                [attr.title]="'Ver partida presupuestaria'"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
              </button>
              <button
                type="button"
                class="danger-button icon-button"
                (click)="promptDelete(partida)"
                [disabled]="loading() || saving()"
                [attr.aria-label]="'Eliminar partida presupuestaria: ' + partida.concepto"
                [attr.title]="'Eliminar partida presupuestaria'"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <polyline points="3 6 5 6 21 6" />
                  <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                  <path d="M10 11v6" />
                  <path d="M14 11v6" />
                  <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                </svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <app-confirm-dialog
    [open]="partidaPendingDelete() !== null"
    title="Eliminar partida presupuestaria"
    [message]="deleteMessage()"
    confirmLabel="Eliminar"
    cancelLabel="Cancelar"
    busyLabel="Eliminando..."
    [busy]="deleting()"
    [confirmDestructive]="true"
    (cancel)="closeDeleteDialog()"
    (confirm)="confirmDeletePartida()"
  ></app-confirm-dialog>

  <app-confirm-dialog
    [open]="cancelDialogOpen()"
    [title]="cancelDialogTitle()"
    [message]="cancelDialogMessage()"
    confirmLabel="Sí, cancelar"
    cancelLabel="Seguir creando"
    (cancel)="closeCancelDialog()"
    (confirm)="confirmCancelForm()"
  ></app-confirm-dialog>

  <section *ngIf="!showForm() && viewingPartida() as partida" class="budgets-form budgets-form--viewer">
    <header class="budgets-form__header">
      <div>
        <h3 class="budgets-form__title">{{ partida.concepto }}</h3>
        <p class="budgets-form__subtitle">Actualizado {{ partida.actualizadoEn | date: 'short' }}</p>
      </div>
    </header>

    <div class="budgets-form__grid">
      <div class="form-field form-field--static">
        <span>Tipo</span>
        <p class="form-field__readonly">
          <span class="tipo-pill" [ngClass]="partida.tipo === 'INGRESO' ? 'tipo-pill--ingreso' : 'tipo-pill--egreso'">
            {{ partida.tipo }}
          </span>
        </p>
      </div>

      <div class="form-field form-field--static">
        <span>Categoría</span>
        <p class="form-field__readonly">{{ partida.categoriaNombre }}</p>
      </div>

      <div class="form-field form-field--static">
        <span>Estado</span>
        <p class="form-field__readonly">
          <span class="estado" [ngClass]="'estado--' + partida.estado.toLowerCase()">{{ partida.estado }}</span>
        </p>
      </div>

      <div class="form-field form-field--static form-field--full">
        <span>Periodo</span>
        <p class="form-field__readonly">
          {{ partida.periodoNombre }}
          ({{ partida.periodoFechaInicio | date: 'longDate' }} - {{ partida.periodoFechaFin | date: 'longDate' }})
        </p>
      </div>

      <div class="form-field form-field--static">
        <span>Monto reservado</span>
        <p class="form-field__readonly form-field__readonly--split">
          <span>{{ formatAccounting(partida.montoReservado) }}</span>
          <button
            *ngIf="partida.estado === 'RESERVADO'"
            type="button"
            class="primary-button primary-button--compact"
            (click)="startApplyMonto(partida)"
            [disabled]="applyingMonto() || applyingMontoSaving()"
          >
            Aplicar
          </button>
        </p>
      </div>

      <div
        class="form-field form-field--static"
        [class.form-field--invalid]="applyingMonto() && montoAplicadoControl.touched && montoAplicadoControl.invalid"
      >
        <span>Monto aplicado</span>
        <ng-container *ngIf="applyingMonto(); else appliedReadonly">
          <div class="budgets__apply-grid">
            <div class="budgets__apply-input">
              <input type="number" min="0" step="0.01" [formControl]="montoAplicadoControl" />
            </div>
            <div class="budgets__apply-actions">
              <button
                type="button"
                class="primary-button primary-button--compact"
                (click)="confirmApplyMonto(partida)"
                [disabled]="applyingMontoSaving()"
                aria-label="Aceptar"
              >
                <span aria-hidden="true">&#10003;</span>
              </button>
              <button
                type="button"
                class="danger-button danger-button--compact"
                (click)="cancelApplyMonto()"
                [disabled]="applyingMontoSaving()"
                aria-label="Cancelar"
              >
                <span aria-hidden="true">&#10005;</span>
              </button>
            </div>
          </div>
          <small *ngIf="montoAplicadoControl.touched && montoAplicadoControl.hasError('required')">
            Ingresa el monto a aplicar.
          </small>
          <small *ngIf="montoAplicadoControl.touched && montoAplicadoControl.hasError('min')">
            El monto aplicado no puede ser negativo.
          </small>
          <small *ngIf="applyingMontoError() as applyError">{{ applyError }}</small>
        </ng-container>
        <ng-template #appliedReadonly>
          <p class="form-field__readonly">{{ formatAccounting(partida.montoAplicado ?? null) }}</p>
        </ng-template>
      </div>

      <div class="form-field form-field--static">
        <span>Creado</span>
        <p class="form-field__readonly">
          {{ partida.creadoEn | date: 'longDate' }}
          a las {{ partida.creadoEn | date: 'shortTime' }}
        </p>
      </div>

      <div class="form-field form-field--static">
        <span>Actualizado</span>
        <p class="form-field__readonly">
          {{ partida.actualizadoEn | date: 'longDate' }}
          a las {{ partida.actualizadoEn | date: 'shortTime' }}
        </p>
      </div>

      <div class="form-field form-field--static form-field--full">
        <span>Nota</span>
        <p class="form-field__readonly">{{ partida.nota?.trim() || 'Sin nota registrada.' }}</p>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="ghost-button" (click)="closeViewPartida()">
        Volver
      </button>
    </div>
  </section>
</section>
