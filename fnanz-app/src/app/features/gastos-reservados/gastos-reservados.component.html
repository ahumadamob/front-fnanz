<section class="card gasto-panel">
  <header class="gasto-panel__header">
    <div>
      <h2>Presupuestos</h2>
      <p class="gasto-panel__subtitle">
        Administra los compromisos de ingresos o egresos reservados para futuros períodos.
      </p>
    </div>
    <button
      type="button"
      class="primary-button"
      (click)="startCreate()"
      [disabled]="loading() || saving() || selectedPeriodoId() === null"
    >
      Nueva partida presupuestaria
    </button>
  </header>

  <p *ngIf="loading()" class="gasto-panel__loading">Cargando información...</p>
  <p *ngIf="error() && !loading()" class="gasto-panel__error">{{ error() }}</p>
  <p *ngIf="categoriasError()" class="gasto-panel__warning">{{ categoriasError() }}</p>
  <p *ngIf="periodosError()" class="gasto-panel__warning">{{ periodosError() }}</p>
  <p *ngIf="periodosDropdownError()" class="gasto-panel__warning">{{ periodosDropdownError() }}</p>

  <section *ngIf="!showForm() && !viewingGasto()" class="gasto-panel__filters">
    <label class="filter-field">
      <span>Periodo financiero</span>
      <select
        [disabled]="periodosDropdownLoading() || periodosDropdown().length === 0"
        [value]="selectedPeriodoId() ?? ''"
        (change)="onPeriodoDropdownChange($any($event.target).value)"
      >
        <option value="">Selecciona un periodo</option>
        <option *ngFor="let periodo of periodosDropdown()" [value]="periodo.id">
          {{ periodo.nombre }}
        </option>
      </select>
    </label>

    <label class="filter-checkbox">
      <input
        type="checkbox"
        [checked]="includePeriodosCerrados()"
        (change)="onIncludePeriodosCerradosChange($any($event.target).checked)"
      />
      <span>Incluir periodos cerrados</span>
    </label>
  </section>

  <p *ngIf="periodosDropdownLoading() && !showForm() && !viewingGasto()" class="gasto-panel__loading">
    Cargando periodos financieros...
  </p>

  <section *ngIf="showForm()" class="gasto-form">
    <h3>{{ formTitle() }}</h3>
    <form [formGroup]="form" (ngSubmit)="submitForm()" class="gasto-form__grid">
      <label class="form-field" [class.form-field--invalid]="hasControlError('tipo')">
        <span>Tipo *</span>
        <select formControlName="tipo">
          <option *ngFor="let tipo of tipoOptions" [value]="tipo">{{ tipo }}</option>
        </select>
        <small *ngIf="getServerError('tipo') as serverError">{{ serverError }}</small>
      </label>

      <label class="form-field" [class.form-field--invalid]="hasControlError('categoriaId')">
        <span>Categoría *</span>
        <select formControlName="categoriaId" [disabled]="categoriasLoading() || categorias().length === 0">
          <option [ngValue]="null" disabled>Seleccione una categoría</option>
          <option *ngFor="let categoria of categorias()" [ngValue]="categoria.id">
            {{ categoria.nombre }} ({{ categoria.tipo }})
          </option>
        </select>
        <small *ngIf="form.controls.categoriaId.touched && form.controls.categoriaId.hasError('required')">
          La categoría es obligatoria.
        </small>
        <small *ngIf="getServerError('categoriaId') as serverError">{{ serverError }}</small>
        <small *ngIf="!categoriasLoading() && categorias().length === 0">
          Debes crear al menos una categoría financiera para asignarla a la partida presupuestaria.
        </small>
      </label>

      <label class="form-field" [class.form-field--invalid]="hasControlError('concepto')">
        <span>Concepto *</span>
        <input type="text" formControlName="concepto" [class.invalid]="form.controls.concepto.touched && form.controls.concepto.invalid" />
        <small *ngIf="form.controls.concepto.touched && form.controls.concepto.hasError('required')">
          El concepto es obligatorio.
        </small>
        <small *ngIf="form.controls.concepto.touched && form.controls.concepto.hasError('maxlength')">
          El concepto debe tener menos de 200 caracteres.
        </small>
        <small *ngIf="getServerError('concepto') as serverError">{{ serverError }}</small>
      </label>

      <ng-container *ngIf="selectedGasto()">
        <label class="form-field" [class.form-field--invalid]="hasControlError('periodoId')">
          <span>Periodo *</span>
          <select formControlName="periodoId" [disabled]="periodosLoading() || periodos().length === 0">
            <option [ngValue]="null" disabled>Seleccione un periodo</option>
            <option *ngFor="let periodo of periodos()" [ngValue]="periodo.id">
              {{ periodo.nombre }} ({{ periodo.fechaInicio | date: 'longDate' }} -
              {{ periodo.fechaFin | date: 'longDate' }})
            </option>
          </select>
          <small *ngIf="form.controls.periodoId.touched && form.controls.periodoId.hasError('required')">
            El periodo es obligatorio.
          </small>
          <small *ngIf="getServerError('periodoId') as serverError">{{ serverError }}</small>
          <small *ngIf="!periodosLoading() && periodos().length === 0">
            Debes crear al menos un periodo financiero para asignarlo a la partida presupuestaria.
          </small>
        </label>

        <label class="form-field" [class.form-field--invalid]="hasControlError('estado')">
          <span>Estado *</span>
          <select formControlName="estado">
            <option *ngFor="let estado of estadoOptions" [value]="estado">{{ estado }}</option>
          </select>
          <small *ngIf="getServerError('estado') as serverError">{{ serverError }}</small>
        </label>

        <label class="form-field" [class.form-field--invalid]="hasControlError('montoAplicado')">
          <span>Monto aplicado</span>
          <input type="number" formControlName="montoAplicado" step="0.01" min="0" />
          <small *ngIf="form.controls.montoAplicado.touched && form.controls.montoAplicado.hasError('min')">
            El monto aplicado no puede ser negativo.
          </small>
          <small *ngIf="getServerError('montoAplicado') as serverError">{{ serverError }}</small>
        </label>
      </ng-container>

      <label class="form-field" [class.form-field--invalid]="hasControlError('montoReservado')">
        <span>Monto reservado *</span>
        <input
          type="number"
          formControlName="montoReservado"
          step="0.01"
          min="0"
          [class.invalid]="form.controls.montoReservado.touched && form.controls.montoReservado.invalid"
        />
        <small *ngIf="form.controls.montoReservado.touched && form.controls.montoReservado.hasError('required')">
          El monto reservado es obligatorio.
        </small>
        <small *ngIf="form.controls.montoReservado.touched && form.controls.montoReservado.hasError('min')">
          El monto reservado no puede ser negativo.
        </small>
        <small *ngIf="getServerError('montoReservado') as serverError">{{ serverError }}</small>
      </label>

      <label class="form-field form-field--full" [class.form-field--invalid]="hasControlError('nota')">
        <span>Nota</span>
        <textarea rows="3" formControlName="nota"></textarea>
        <small *ngIf="form.controls.nota.touched && form.controls.nota.hasError('maxlength')">
          La nota debe tener menos de 500 caracteres.
        </small>
        <small *ngIf="getServerError('nota') as serverError">{{ serverError }}</small>
      </label>

      <div class="form-actions">
        <button type="button" class="ghost-button" (click)="promptCancelForm()" [disabled]="saving()">
          Cancelar
        </button>
        <button type="submit" class="primary-button" [disabled]="saving()">
          {{ saving() ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </section>

  <div *ngIf="!showForm() && !viewingGasto()" class="gasto-grid">
    <table class="data-table">
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Tipo</th>
          <th>Categoría</th>
          <th>Estado</th>
          <th>Monto reservado</th>
          <th>Monto aplicado</th>
          <th class="data-table__actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="gastos().length === 0">
          <td class="data-table__empty" colspan="7">
            <ng-container *ngIf="loading(); else emptyMessage">
              Cargando información...
            </ng-container>
            <ng-template #emptyMessage>
              {{
                selectedPeriodoId() === null
                  ? 'Selecciona un periodo financiero para ver las partidas presupuestarias.'
                  : 'No hay partidas presupuestarias registradas para el periodo seleccionado.'
              }}
            </ng-template>
          </td>
        </tr>
        <tr *ngFor="let gasto of gastos(); trackBy: trackByGastoId">
          <td>
            <div class="gasto-name">{{ gasto.concepto }}</div>
          </td>
          <td>
            <span class="tipo-pill" [ngClass]="gasto.tipo === 'INGRESO' ? 'tipo-pill--ingreso' : 'tipo-pill--egreso'">
              {{ gasto.tipo }}
            </span>
          </td>
          <td>{{ gasto.categoriaNombre }}</td>
          <td>
            <span [ngClass]="'estado estado--' + gasto.estado.toLowerCase()">{{ gasto.estado }}</span>
          </td>
          <td class="data-table__numeric">{{ formatAccounting(gasto.montoReservado) }}</td>
          <td class="data-table__numeric">{{ formatAccounting(gasto.montoAplicado) }}</td>
          <td class="data-table__actions">
            <button
              type="button"
              class="ghost-button icon-button"
              (click)="viewGasto(gasto)"
              [disabled]="loading() || saving()"
              [attr.aria-label]="'Ver partida presupuestaria: ' + gasto.concepto"
              [attr.title]="'Ver partida presupuestaria'"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z" />
                <circle cx="12" cy="12" r="3" />
              </svg>
            </button>
            <button
              type="button"
              class="ghost-button icon-button"
              (click)="startEdit(gasto)"
              [disabled]="loading() || saving()"
              [attr.aria-label]="'Editar partida presupuestaria: ' + gasto.concepto"
              [attr.title]="'Editar partida presupuestaria'"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M12 20h9" />
                <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
              </svg>
            </button>
            <button
              type="button"
              class="danger-button icon-button"
              (click)="promptDelete(gasto)"
              [disabled]="loading() || saving()"
              [attr.aria-label]="'Eliminar partida presupuestaria: ' + gasto.concepto"
              [attr.title]="'Eliminar partida presupuestaria'"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                <path d="M10 11v6" />
                <path d="M14 11v6" />
                <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
              </svg>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <app-confirm-dialog
    [open]="gastoPendingDelete() !== null"
    title="Eliminar partida presupuestaria"
    [message]="deleteMessage()"
    confirmLabel="Eliminar"
    cancelLabel="Cancelar"
    busyLabel="Eliminando..."
    [busy]="deleting()"
    [confirmDestructive]="true"
    (cancel)="closeDeleteDialog()"
    (confirm)="confirmDeleteGasto()"
  ></app-confirm-dialog>

  <app-confirm-dialog
    [open]="cancelDialogOpen()"
    [title]="cancelDialogTitle()"
    [message]="cancelDialogMessage()"
    confirmLabel="Sí, cancelar"
    cancelLabel="Seguir editando"
    (cancel)="closeCancelDialog()"
    (confirm)="confirmCancelForm()"
  ></app-confirm-dialog>

  <section *ngIf="!showForm() && viewingGasto() as gasto" class="gasto-form">
    <header class="gasto-panel__header">
      <div>
        <h3>{{ gasto.concepto }}</h3>
        <p class="gasto-panel__subtitle">Actualizado {{ gasto.actualizadoEn | date: 'short' }}</p>
      </div>
    </header>

    <div class="gasto-form__grid">
      <div class="form-field form-field--static">
        <span>Tipo</span>
        <p class="form-field__readonly">
          <span
            class="tipo-pill"
            [ngClass]="gasto.tipo === 'INGRESO' ? 'tipo-pill--ingreso' : 'tipo-pill--egreso'"
          >
            {{ gasto.tipo }}
          </span>
        </p>
      </div>

      <div class="form-field form-field--static">
        <span>Categoría</span>
        <p class="form-field__readonly">{{ gasto.categoriaNombre }}</p>
      </div>

      <div class="form-field form-field--static">
        <span>Estado</span>
        <p class="form-field__readonly">
          <span class="estado" [ngClass]="'estado--' + gasto.estado.toLowerCase()">{{ gasto.estado }}</span>
        </p>
      </div>

      <div class="form-field form-field--static form-field--full">
        <span>Periodo</span>
        <p class="form-field__readonly">
          {{ gasto.periodoNombre }}
          ({{ gasto.periodoFechaInicio | date: 'longDate' }} - {{ gasto.periodoFechaFin | date: 'longDate' }})
        </p>
      </div>

      <div class="form-field form-field--static">
        <span>Monto reservado</span>
        <p class="form-field__readonly">{{ formatAccounting(gasto.montoReservado) }}</p>
      </div>

      <div class="form-field form-field--static">
        <span>Monto aplicado</span>
        <p class="form-field__readonly">{{ formatAccounting(gasto.montoAplicado ?? null) }}</p>
      </div>

      <div class="form-field form-field--static">
        <span>Creado</span>
        <p class="form-field__readonly">
          {{ gasto.creadoEn | date: 'longDate' }}
          a las {{ gasto.creadoEn | date: 'shortTime' }}
        </p>
      </div>

      <div class="form-field form-field--static">
        <span>Actualizado</span>
        <p class="form-field__readonly">
          {{ gasto.actualizadoEn | date: 'longDate' }}
          a las {{ gasto.actualizadoEn | date: 'shortTime' }}
        </p>
      </div>

      <div class="form-field form-field--static form-field--full">
        <span>Nota</span>
        <p class="form-field__readonly">{{ gasto.nota?.trim() || 'Sin nota registrada.' }}</p>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="ghost-button" (click)="closeViewGasto()">
        Volver
      </button>
    </div>
  </section>
</section>
