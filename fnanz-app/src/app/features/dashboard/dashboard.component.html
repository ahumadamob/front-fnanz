<section class="card resumen-panel shadow-sm border-0">
  <div class="card-body">
    <header class="resumen-panel__header">
      <div>
        <h2 class="card-title mb-1">Resumen de partidas presupuestarias por categoría</h2>
        <p class="card-subtitle text-muted resumen-panel__subtitle">
          Periodo:
          <ng-container *ngIf="selectedPeriodoNombre(); else periodoFallback">
            {{ selectedPeriodoNombre() }}
          </ng-container>
          <ng-template #periodoFallback>
            {{ selectedPeriodoId() ? ('#' + selectedPeriodoId()) : 'Selecciona un periodo' }}
          </ng-template>
        </p>
      </div>

      <div class="resumen-panel__controls">
        <label class="resumen-panel__label" for="resumenPeriodoSelect">Periodo financiero</label>
        <select
          #periodoSelect
          id="resumenPeriodoSelect"
          class="form-select"
          [disabled]="loadingPeriodos()"
          (change)="onPeriodoChange(periodoSelect.value)"
        >
          <option *ngIf="loadingPeriodos()" selected>
            Cargando periodos...
          </option>
          <ng-container *ngIf="!loadingPeriodos()">
            <option *ngIf="periodos().length === 0" selected disabled>
              No hay periodos disponibles
            </option>
            <option
              *ngFor="let periodo of periodos()"
              [value]="periodo.id"
              [selected]="periodo.id === selectedPeriodoId()"
            >
              {{ periodo.nombre }}
            </option>
          </ng-container>
        </select>
      </div>
    </header>

    <button type="button" class="ghost-button resumen-panel__back" routerLink="/periodos">
      Ver todos los periodos
    </button>

    <p *ngIf="periodosError()" class="resumen-panel__error">{{ periodosError() }}</p>

    <p
      *ngIf="!loadingPeriodos() && periodos().length === 0 && !periodosError()"
      class="resumen-panel__empty"
    >
      No hay periodos financieros disponibles para mostrar un resumen.
    </p>

    <p *ngIf="loadingResumen()" class="resumen-panel__loading">Cargando resumen...</p>
    <p *ngIf="resumenError() && !loadingResumen()" class="resumen-panel__error">{{ resumenError() }}</p>

    <ng-container
      *ngIf="
        !loadingResumen() && !resumenError() && selectedPeriodoId() !== null && resumen() as resumenData
      "
    >
      <ng-container *ngIf="resumenData; else emptyState">
        <section class="resumen-grid">
          <article class="resumen-card">
            <header>
              <h3>Ingresos</h3>
              <span class="monto-pill monto-pill--ingreso">
                Reservado:
                {{ resumenData.totalIngresos.montoReservado | currency: 'USD':'symbol-narrow':'1.0-0' }}
              </span>
            </header>

            <p *ngIf="resumenData.ingresos.length === 0" class="resumen-card__empty">
              No hay partidas de ingreso para este periodo.
            </p>

            <table *ngIf="resumenData.ingresos.length > 0" class="resumen-table">
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th>Reservado</th>
                  <th>Aplicado</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let ingreso of resumenData.ingresos; trackBy: trackByCategoriaId">
                  <td>
                    <div class="categoria-nombre">{{ ingreso.categoriaNombre }}</div>
                    <small *ngIf="ingreso.orden != null" class="categoria-orden">Orden {{ ingreso.orden }}</small>
                  </td>
                  <td>
                    {{ ingreso.montoReservado | currency: 'USD':'symbol-narrow':'1.0-0' }}
                  </td>
                  <td>
                    {{ ingreso.montoAplicado | currency: 'USD':'symbol-narrow':'1.0-0' }}
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td>
                    {{ resumenData.totalIngresos.montoReservado | currency: 'USD':'symbol-narrow':'1.0-0' }}
                  </td>
                  <td>
                    {{ resumenData.totalIngresos.montoAplicado | currency: 'USD':'symbol-narrow':'1.0-0' }}
                  </td>
                </tr>
              </tfoot>
            </table>
          </article>

          <article class="resumen-card">
            <header>
              <h3>Egresos</h3>
              <span class="monto-pill monto-pill--egreso">
                Reservado:
                {{ resumenData.totalEgresos.montoReservado | currency: 'USD':'symbol-narrow':'1.0-0' }}
              </span>
            </header>

            <p *ngIf="resumenData.egresos.length === 0" class="resumen-card__empty">
              No hay partidas de egreso para este periodo.
            </p>

            <table *ngIf="resumenData.egresos.length > 0" class="resumen-table">
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th>Reservado</th>
                  <th>Aplicado</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let egreso of resumenData.egresos; trackBy: trackByCategoriaId">
                  <td>
                    <div class="categoria-nombre">{{ egreso.categoriaNombre }}</div>
                    <small *ngIf="egreso.orden != null" class="categoria-orden">Orden {{ egreso.orden }}</small>
                  </td>
                  <td>
                    {{ egreso.montoReservado | currency: 'USD':'symbol-narrow':'1.0-0' }}
                  </td>
                  <td>
                    {{ egreso.montoAplicado | currency: 'USD':'symbol-narrow':'1.0-0' }}
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td>
                    {{ resumenData.totalEgresos.montoReservado | currency: 'USD':'symbol-narrow':'1.0-0' }}
                  </td>
                  <td>
                    {{ resumenData.totalEgresos.montoAplicado | currency: 'USD':'symbol-narrow':'1.0-0' }}
                  </td>
                </tr>
              </tfoot>
            </table>
          </article>
        </section>

        <section class="resumen-totales">
          <h3>Total general</h3>
          <div class="totales-grid">
            <div class="total-card">
              <span class="total-label">Monto reservado</span>
              <strong>
                {{ resumenData.totalGeneral.montoReservado | currency: 'USD':'symbol-narrow':'1.0-0' }}
              </strong>
            </div>
            <div class="total-card">
              <span class="total-label">Monto aplicado</span>
              <strong>
                {{ resumenData.totalGeneral.montoAplicado | currency: 'USD':'symbol-narrow':'1.0-0' }}
              </strong>
            </div>
          </div>
        </section>
      </ng-container>
    </ng-container>

    <ng-template #emptyState>
      <p class="resumen-panel__empty">
        No hay información de partidas presupuestarias para este periodo.
      </p>
    </ng-template>
  </div>
</section>
