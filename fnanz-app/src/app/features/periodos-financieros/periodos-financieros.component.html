<section class="card periodo-panel">
  <header class="periodo-panel__header">
    <div>
      <h2>Periodos financieros</h2>
      <p class="periodo-panel__subtitle">
        Gestiona los periodos utilizados para organizar tus registros financieros.
      </p>
    </div>
    <button type="button" class="primary-button" (click)="startCreate()" [disabled]="loading() || saving()">
      Nuevo periodo financiero
    </button>
  </header>

  <p *ngIf="loading()" class="periodo-panel__loading">Cargando información...</p>
  <p *ngIf="error() && !loading()" class="periodo-panel__error">{{ error() }}</p>

  <section *ngIf="showForm()" class="periodo-form">
    <h3>{{ formTitle() }}</h3>
    <form [formGroup]="form" (ngSubmit)="submitForm()" class="periodo-form__grid">
      <label class="form-field" [class.form-field--invalid]="hasControlError('nombre')">
        <span>Nombre *</span>
        <input type="text" formControlName="nombre" />
        <small *ngIf="form.controls.nombre.touched && form.controls.nombre.hasError('required')">
          El nombre es obligatorio.
        </small>
        <small *ngIf="form.controls.nombre.touched && form.controls.nombre.hasError('maxlength')">
          El nombre debe tener menos de 150 caracteres.
        </small>
        <small *ngIf="getServerError('nombre') as serverError">{{ serverError }}</small>
      </label>

      <label class="form-field" [class.form-field--invalid]="hasControlError('fechaInicio')">
        <span>Fecha de inicio *</span>
        <input type="date" formControlName="fechaInicio" />
        <small *ngIf="form.controls.fechaInicio.touched && form.controls.fechaInicio.hasError('required')">
          La fecha de inicio es obligatoria.
        </small>
        <small *ngIf="getServerError('fechaInicio') as serverError">{{ serverError }}</small>
      </label>

      <label class="form-field" [class.form-field--invalid]="hasControlError('fechaFin')">
        <span>Fecha de fin *</span>
        <input type="date" formControlName="fechaFin" />
        <small *ngIf="form.controls.fechaFin.touched && form.controls.fechaFin.hasError('required')">
          La fecha de fin es obligatoria.
        </small>
        <small *ngIf="form.controls.fechaFin.touched && form.controls.fechaFin.hasError('dateRange')">
          La fecha de fin debe ser posterior o igual a la fecha de inicio.
        </small>
        <small *ngIf="getServerError('fechaFin') as serverError">{{ serverError }}</small>
      </label>

      <label class="form-field" [class.form-field--invalid]="hasControlError('tipo')">
        <span>Tipo</span>
        <input type="text" formControlName="tipo" placeholder="Ej: Mensual, Trimestral" />
        <small *ngIf="getServerError('tipo') as serverError">{{ serverError }}</small>
      </label>

      <label class="form-field form-field--full" [class.form-field--invalid]="hasControlError('descripcion')">
        <span>Descripción</span>
        <textarea rows="3" formControlName="descripcion"></textarea>
        <small *ngIf="getServerError('descripcion') as serverError">{{ serverError }}</small>
      </label>

      <label class="form-field form-field--inline" [class.form-field--invalid]="hasControlError('cerrado')">
        <input type="checkbox" formControlName="cerrado" />
        <span>Periodo cerrado</span>
        <small *ngIf="getServerError('cerrado') as serverError">{{ serverError }}</small>
      </label>

      <div class="form-actions">
        <button type="button" class="ghost-button" (click)="cancelForm()">Cancelar</button>
        <button type="submit" class="primary-button" [disabled]="saving()">
          {{ saving() ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </section>

  <div class="periodo-grid" *ngIf="!loading() && periodos().length > 0; else emptyState">
    <table class="data-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Rango</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Descripción</th>
          <th class="data-table__actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let periodo of periodos(); trackBy: trackByPeriodoId">
          <td>
            <div class="periodo-name">{{ periodo.nombre }}</div>
            <small class="periodo-meta">Actualizado {{ periodo.actualizadoEn | date: 'short' }}</small>
          </td>
          <td>
            <div>{{ periodo.fechaInicio | date: 'mediumDate' }} – {{ periodo.fechaFin | date: 'mediumDate' }}</div>
          </td>
          <td>{{ periodo.tipo || '—' }}</td>
          <td>
            <span [ngClass]="periodo.cerrado ? 'estado estado--cerrado' : 'estado estado--abierto'">
              {{ periodo.cerrado ? 'Cerrado' : 'Abierto' }}
            </span>
          </td>
          <td>{{ periodo.descripcion || 'Sin descripción' }}</td>
          <td class="data-table__actions">
            <button
              type="button"
              class="ghost-button"
              [routerLink]="['/periodos-financieros', periodo.id, 'reservas-resumen']"
              [state]="{ periodoNombre: periodo.nombre }"
            >
              Ver resumen
            </button>
            <button
              type="button"
              class="ghost-button icon-button"
              (click)="startEdit(periodo)"
              [disabled]="loading() || saving()"
              [attr.aria-label]="'Editar periodo financiero: ' + periodo.nombre"
              [attr.title]="'Editar periodo financiero'"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M12 20h9" />
                <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
              </svg>
            </button>
            <button
              type="button"
              class="danger-button icon-button"
              (click)="promptDelete(periodo)"
              [disabled]="loading() || saving()"
              [attr.aria-label]="'Eliminar periodo financiero: ' + periodo.nombre"
              [attr.title]="'Eliminar periodo financiero'"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                <path d="M10 11v6" />
                <path d="M14 11v6" />
                <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
              </svg>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #emptyState>
    <p class="periodo-panel__empty" *ngIf="!loading()">
      No hay periodos financieros registrados todavía. Crea el primero para comenzar.
    </p>
  </ng-template>

  <app-confirm-dialog
    [open]="periodoPendingDelete() !== null"
    title="Eliminar periodo"
    [message]="deleteMessage()"
    confirmLabel="Eliminar"
    cancelLabel="Cancelar"
    busyLabel="Eliminando..."
    [busy]="deleting()"
    [confirmDestructive]="true"
    (cancel)="closeDeleteDialog()"
    (confirm)="confirmDeletePeriodo()"
  ></app-confirm-dialog>
</section>
