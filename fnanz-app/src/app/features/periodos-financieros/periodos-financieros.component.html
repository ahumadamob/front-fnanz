<section class="card periodo-panel shadow-sm border-0">
  <div class="card-body">
    <div class="periodo-panel__header">
      <div>
        <h2 class="card-title mb-1">Periodos</h2>
        <p class="card-subtitle text-muted">
          Gestiona los periodos utilizados para organizar tus registros financieros.
        </p>
      </div>
      <button type="button" class="btn btn-primary" (click)="startCreate()" [disabled]="loading() || saving()">
        Nuevo periodo
      </button>
    </div>

    <div *ngIf="loading()" class="alert alert-info mt-3 mb-0" role="status">Cargando información...</div>
    <div *ngIf="error() && !loading()" class="alert alert-danger mt-3 mb-0" role="alert">{{ error() }}</div>

    <section *ngIf="showForm()" class="periodo-form-wrapper mt-4">
      <div class="card border-dark periodo-form-card">
        <div class="card-header">
          <h5 class="mb-0">{{ formTitle() }}</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="form" (ngSubmit)="submitForm()" novalidate>
            <div class="mb-3">
              <label for="periodoNombre" class="form-label fw-semibold">Nombre *</label>
              <input
                id="periodoNombre"
                type="text"
                formControlName="nombre"
                class="form-control"
                [class.is-invalid]="hasControlError('nombre')"
              />
              <div class="invalid-feedback" *ngIf="form.controls.nombre.touched && form.controls.nombre.hasError('required')">
                El nombre es obligatorio.
              </div>
              <div class="invalid-feedback" *ngIf="form.controls.nombre.touched && form.controls.nombre.hasError('maxlength')">
                El nombre debe tener menos de 150 caracteres.
              </div>
              <div class="invalid-feedback" *ngIf="getServerError('nombre') as serverError">{{ serverError }}</div>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="periodoFechaInicio" class="form-label fw-semibold">Fecha de inicio *</label>
                <input
                  id="periodoFechaInicio"
                  type="date"
                  formControlName="fechaInicio"
                  class="form-control"
                  [class.is-invalid]="hasControlError('fechaInicio')"
                />
                <div class="invalid-feedback" *ngIf="form.controls.fechaInicio.touched && form.controls.fechaInicio.hasError('required')">
                  La fecha de inicio es obligatoria.
                </div>
                <div class="invalid-feedback" *ngIf="getServerError('fechaInicio') as serverError">{{ serverError }}</div>
              </div>
              <div class="col-md-6">
                <label for="periodoFechaFin" class="form-label fw-semibold">Fecha de fin *</label>
                <input
                  id="periodoFechaFin"
                  type="date"
                  formControlName="fechaFin"
                  class="form-control"
                  [class.is-invalid]="
                    hasControlError('fechaFin') ||
                    (form.controls.fechaFin.touched && form.controls.fechaFin.hasError('dateRange'))
                  "
                />
                <div class="invalid-feedback" *ngIf="form.controls.fechaFin.touched && form.controls.fechaFin.hasError('required')">
                  La fecha de fin es obligatoria.
                </div>
                <div class="invalid-feedback" *ngIf="form.controls.fechaFin.touched && form.controls.fechaFin.hasError('dateRange')">
                  La fecha de fin debe ser posterior o igual a la fecha de inicio.
                </div>
                <div class="invalid-feedback" *ngIf="getServerError('fechaFin') as serverError">{{ serverError }}</div>
              </div>
            </div>

            <div class="mt-3">
              <label for="periodoTipo" class="form-label fw-semibold">Tipo</label>
              <input
                id="periodoTipo"
                type="text"
                formControlName="tipo"
                class="form-control"
                placeholder="Ej: Mensual, Trimestral"
                [ngClass]="{ 'is-invalid': getServerError('tipo') }"
              />
              <div class="invalid-feedback" *ngIf="getServerError('tipo') as serverError">{{ serverError }}</div>
            </div>

            <div class="mb-3">
              <label for="periodoDescripcion" class="form-label fw-semibold">Descripción</label>
              <textarea
                id="periodoDescripcion"
                rows="3"
                formControlName="descripcion"
                class="form-control"
                [ngClass]="{ 'is-invalid': getServerError('descripcion') }"
              ></textarea>
              <div class="invalid-feedback" *ngIf="getServerError('descripcion') as serverError">{{ serverError }}</div>
            </div>

            <div class="mt-3">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  role="switch"
                  id="periodoCerrado"
                  formControlName="cerrado"
                />
                <label class="form-check-label" for="periodoCerrado">Periodo cerrado</label>
              </div>
              <div class="form-text">{{ form.controls.cerrado.value ? 'El periodo estará cerrado' : 'El periodo estará abierto' }}</div>
              <div class="invalid-feedback d-block" *ngIf="getServerError('cerrado') as serverError">{{ serverError }}</div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
              <button type="button" class="btn btn-outline-secondary" (click)="cancelForm()">Cancelar</button>
              <button type="submit" class="btn btn-primary" [disabled]="saving()">
                {{ saving() ? 'Guardando...' : 'Guardar' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <ng-container *ngIf="!showForm()">
      <div class="periodo-grid" *ngIf="!loading() && periodos().length > 0; else emptyState">
        <div class="card border-0 shadow-sm mt-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Nombre</th>
                    <th scope="col">Rango</th>
                    <th scope="col">Tipo</th>
                    <th scope="col">Estado</th>
                    <th scope="col">Descripción</th>
                    <th scope="col" class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let periodo of periodos(); trackBy: trackByPeriodoId">
                    <td class="fw-semibold">
                      {{ periodo.nombre }}
                      <div class="text-muted small" *ngIf="periodo.actualizadoEn">
                        Actualizado {{ periodo.actualizadoEn | date: 'short' }}
                      </div>
                    </td>
                    <td>
                      {{ periodo.fechaInicio | date: 'mediumDate' }} – {{ periodo.fechaFin | date: 'mediumDate' }}
                    </td>
                    <td>{{ periodo.tipo || '—' }}</td>
                    <td>
                      <span [ngClass]="periodo.cerrado ? 'estado estado--cerrado' : 'estado estado--abierto'">
                        {{ periodo.cerrado ? 'Cerrado' : 'Abierto' }}
                      </span>
                    </td>
                    <td>{{ periodo.descripcion || 'Sin descripción' }}</td>
                    <td class="text-end">
                      <a
                        class="btn btn-outline-secondary btn-sm me-2"
                        [routerLink]="['/periodos', periodo.id, 'reservas-resumen']"
                        [state]="{ periodoNombre: periodo.nombre }"
                      >
                        Ver resumen
                      </a>
                      <button
                        type="button"
                        class="btn btn-outline-primary action-icon-button me-1"
                        (click)="startEdit(periodo)"
                        [disabled]="loading() || saving()"
                        [attr.aria-label]="'Editar periodo: ' + periodo.nombre"
                        [attr.title]="'Editar periodo'"
                      >
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <path d="M12 20h9" />
                          <path
                            d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"
                          />
                        </svg>
                        <span class="visually-hidden">Editar</span>
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-danger action-icon-button"
                        (click)="promptDelete(periodo)"
                        [disabled]="loading() || saving()"
                        [attr.aria-label]="'Eliminar periodo: ' + periodo.nombre"
                        [attr.title]="'Eliminar periodo'"
                      >
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <polyline points="3 6 5 6 21 6" />
                          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                          <path d="M10 11v6" />
                          <path d="M14 11v6" />
                          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                        </svg>
                        <span class="visually-hidden">Eliminar</span>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <ng-template #emptyState>
        <div class="alert alert-secondary mt-4" *ngIf="!loading()">
          No hay periodos registrados todavía. Crea el primero para comenzar.
        </div>
      </ng-template>
    </ng-container>

    <ng-container *ngIf="periodoPendingDelete() as periodo">
      <div
        class="modal fade show d-block periodo-delete-modal"
        tabindex="-1"
        role="dialog"
        aria-modal="true"
        aria-labelledby="periodoDeleteModalLabel"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="periodoDeleteModalLabel">Eliminar periodo</h5>
              <button
                type="button"
                class="btn-close"
                aria-label="Cerrar"
                (click)="closeDeleteDialog()"
                [disabled]="deleting()"
              >
                <span aria-hidden="true"></span>
              </button>
            </div>
            <div class="modal-body">
              <p>¿Desea eliminar el periodo "{{ periodo.nombre }}"?</p>
              <p class="mb-0 text-muted">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-danger"
                (click)="confirmDeletePeriodo()"
                [disabled]="deleting()"
              >
                {{ deleting() ? 'Eliminando...' : 'Eliminar' }}
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="closeDeleteDialog()"
                [disabled]="deleting()"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-backdrop fade show" style="display: block;"></div>
    </ng-container>
  </div>
</section>
